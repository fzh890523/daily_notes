
# lua 正则库 lpeg
据说不错。
参考：
* [Lua 的解析表达式语法](http://www.oschina.net/translate/lpeg-syntax)
* [LPeg编程指南](http://blog.csdn.net/liwenxin_at/article/details/50404524)

# jpg/jpeg质量变换小结

```
所以jpg如果是80压缩的，一般只能继续80(-)下去，80+的话只会增加体积减小实际质量。

-rw-r--r--. 1 root root  71K Aug 12  2016 e473c7b65a483d6930cefbfe4677728611d368c7.jpg
-rw-r--r--. 1 root root 189K Aug 12  2016 e473c7b65a483d6930cefbfe4677728611d368c7.jpg@100Q
-rw-r--r--. 1 root root  71K Aug 12  2016 e473c7b65a483d6930cefbfe4677728611d368c7.jpg@80Q
# root @ local_centos in /tmp [15:50:12] tty:pts/0 L:1 N:172
$ identify -format '%Q' e473c7b65a483d6930cefbfe4677728611d368c7.jpg    
80

# root @ local_centos in /tmp [15:50:22] tty:pts/0 L:1 N:173
$ identify -format '%Q' e473c7b65a483d6930cefbfe4677728611d368c7.jpg@100Q
100
$ identify -format '%Q' e473c7b65a483d6930cefbfe4677728611d368c7.jpg@80Q
80

$ md5sum e473c7b65a483d6930cefbfe4677728611d368c7.jpg*
2a7b7612355a3f98c3211dde3924b2a6  e473c7b65a483d6930cefbfe4677728611d368c7.jpg
552ff90caf2075f20e5cf8e4141ebf12  e473c7b65a483d6930cefbfe4677728611d368c7.jpg@100Q
bcfff77956e871cde3e64aefaffed4ca  e473c7b65a483d6930cefbfe4677728611d368c7.jpg@80Q

结论： 同等质量转换，几乎大小不变，算出来的quality也不变，md5发生变化（说明文件内容还是有点不同）
```

## 肉眼测试
> 原图质量80, 71K/71901

| 操作 | 大小变化 | identify -format '%Q' 结果 | md5 | 肉眼效果 |
| :--- | :--- | :--- | :--- | :--- |
| 转为100 | 增大（189K/193439） | 100 | 变化| 看不出变化 |
| 转为80 | 几乎不变（71783） | 80 | 变化 | 看不出变化 |
| 转为70 | 减小（64380） | 70 | 变化 | 肉眼可见效果变差） |

**结论**
从低到高转换： 质量几乎不变（网上说会降低，但肉眼似乎不可辨），但size有明显增加。 尤其是转为100的话类似重置了quality，成为一张“全新的质量不佳的图”
从高到低转换： 质量降低，size降低

**务必不要用更高的质量进行jpg转换**
比较好的处理方式是用**相对质量转换**，如给原质量80的图传90的压缩质量参数，则压为72质量的新图。 阿里云图片服务的`q`参数就是这样的。
还可以对实际使用的质量参数做**“限高”**，也即和当前质量做比较取较小值。
但是这两种方式都需要算出原图质量参数，目前只发现Magick++可以，需要load图片为Image，而我们目前主要用opencv方案，load两边代价有点大。 哎。


