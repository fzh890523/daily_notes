<!DOCTYPE html>
<html lang="zh">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="//blog.theerrorlog.com/theme/css/skeleton.css" />
    <link rel="stylesheet" href="//blog.theerrorlog.com/theme/css/common_layout.css" />

    <link href="//blog.theerrorlog.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="The Error Log Atom Feed" />

    <script src="//blog.theerrorlog.com/theme/js/require.js"></script>
    <script type="text/javascript">
        require.config({
            baseUrl: "//blog.theerrorlog.com/theme/js",
            shim: {
                "zepto": { exports: "Zepto" }
            }
        });
    </script>
    <script src="//blog.theerrorlog.com/theme/js/common.js"></script>

    <title>Python3中的asyncio - The Error Log</title>

<link rel="stylesheet" href="//blog.theerrorlog.com/theme/css/pygments.css" />
</head>

<body>
    <div class="container" id="main-container">
        <div class="sixteen columns">
            <!-- <h1 id="site-title" style="margin-top: 40px"> -->
            <h1 id="site-title">
                <a href="//blog.theerrorlog.com/#site-title">The Error Log</a>
            </h1>
            <nav>
                <ul>
                    <li><a href="//blog.theerrorlog.com/pages/about-me.html">About Me</a></li>
                    <li class="active"><a href="//blog.theerrorlog.com/category/blog.html#site-title">Blog</a></li>
                    <li><a href="//blog.theerrorlog.com/category/gallery.html#site-title">Gallery</a></li>
                </ul>
            </nav>
            <div class="title-sep">
                <div class="scissors"></div>
                <div class="hr-div"><hr /></div>
            </div>
        </div>
<div class="sixteen columns" style="margin-bottom: 20px">
    <h1>Python3中的asyncio</h1> 
    <span class="post-author">by <a href="//blog.theerrorlog.com/author/kay-zheng.html#site-title">Kay Zheng</a></span>
    <br />
    <span class="post-tags">
        Tags: 
            <a href="//blog.theerrorlog.com/tag/python.html#site-title">python</a>, 
            <a href="//blog.theerrorlog.com/tag/xie-cheng.html#site-title">协程</a>, 
            <a href="//blog.theerrorlog.com/tag/generator.html#site-title">generator</a>
    </span>
    <br />
    <span class="post-date">04 June 2014</span>
</div>
<div class="sixteen columns" id="post-content">
    <h2>2016-2-23 更新</h2>
<p>文中的 AsyncFileWrapper 原意是提供一個在異步事件循環中
操作本地文件的高效方法，但是經各位提醒我才知道，大部分
操作系統其實並不支持本地文件的異步操作，目前在異步事件
循環中訪問本地文件的推薦方法是將訪問操作放到另一個
線程/進程去做（見 <a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.BaseEventLoop.run_in_executor">run_in_executor</a> ）。當然，
AsyncFileWrapper 還是可以用在外設（像串口）和管道上的。</p>
<p>另： Python 3 目前推薦使用 async/await 語法（詳情見我的
<a href="//blog.theerrorlog.com/pep-492-coroutines-with-async-and-await-syntax.html">另一篇文章</a>），本文中的代碼，除了最後的 some_func 函
數以外，在新語法下也是適用的。</p>
<h2>緣起</h2>
<p>最近想换换口味，在用<a href="https://docs.python.org/3/library/asyncio.html">asyncio</a>
写一个小东西，过程中碰到各种概念上、实践上的问题，悄悄
记在这里XD.</p>


<h2>所谓的“异步”</h2>
<p>回归到最初的定义的话，“异步”是指不同硬件之间可以工作在
不同的时钟信号下——试想一下要求所有硬件工作在相同时钟信
号下的系统该有多脆弱。所以同步总线通常出现在与系统本身
工作时钟接近的硬件接口上，而异步总线正好相反，用来连接
远远达不到系统工作频率的硬件。</p>
<p>这些概念投射到同根同源的软件上的话，由于软件命令最终都
是由硬件去执行的，所以软件的操作也有快有慢，“异步操作”
的重点就是协调“快”的操作和“慢”的操作。然后众所周知，最
慢的操作是IO.</p>
<p>与PC硬件里琳琅满目的总线速度不同，软件里一般只有两种速
度：指令执行速度和IO速度——像Erlang计算reduction的时候
也只考虑指令执行时间和IO时间，所有的指令和IO类型都是一
视同仁的。这是为神马呢？大概是因为人脑跟不上电脑吧……</p>
<h2>“正确”的异步操作</h2>
<p>网上到处都是这样的例子：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">message</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
        <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>这是异步操作没错，用另一个进程来处理请求，只是粒度略大，
因为这只是将快的进程（handler进程）和慢的进程（server进
程）分开了而已，无论在handler还是server里都要等待IO. 而
且我在<a href="irc://chat.freenode.net/#python">#python</a>上贴出
这个程序的时候马上有一堆人出来说服务器不应该这样写之类
的XD.</p>
<p>于是武林中就有了下面这种模式：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">selectors</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">selector</span> <span class="o">=</span> <span class="n">selectors</span><span class="o">.</span><span class="n">DefaultSelector</span><span class="p">()</span>
    <span class="n">selector</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_READ</span><span class="p">)</span>

    <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
        <span class="n">event_list</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">events</span> <span class="ow">in</span> <span class="n">event_list</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">fileobj</span>
            <span class="k">if</span> <span class="n">conn</span> <span class="o">==</span> <span class="n">listener</span><span class="p">:</span>
                <span class="n">new_conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">new_conn</span><span class="p">,</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_READ</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">handler</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>我将这个模式称为“在忙完指令之后等待IO”，坊间说的“异步IO”
一般也是特指这种两段式模式：一段等待IO，一段执行指令。别
看上面的程序很简单，很大一部分高性能的服务器或者框架（像
Tornado、Twisted和Erlang）都是基于这个模式的，因为它的资
源消耗比基于多进程/多线程的服务器实在是少太多了（参考Nginx
和Apache的对比），所以扩展性（scalability）也好太多了。</p>
<h2>asyncio模块</h2>
<p>asyncio是在Python 3.4中添加的新模块，实现了上面的“忙完指
令之后等待IO”模式。</p>
<p>这世上已经有好多异步框架和库了，Guido老爷子为什么要推行这
样一个新模块？他在<a href="http://legacy.python.org/dev/peps/pep-3153/">PEP</a>
里说的原因是，这些第三方异步代码相互之间不兼容不能移植
blahblah……我倒觉得是Twisted的camelCaseNaming不合老爷子胃
口而已……</p>
<p>还是上面的echo server例子，用外星科技实现：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">class</span> <span class="nc">EchoProtocol</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connection_made</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>

    <span class="k">def</span> <span class="nf">connection_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">srv</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_server</span><span class="p">(</span><span class="n">EchoProtocol</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">async</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>熟悉Twisted的同学应该会有deja vu的感觉，我们提供一个接收
事件的对象（实际上是产生对象的factory），然后事件就源源不
断地自动出现了。</p>
<p>但是这看起来和之前selector的例子不像啊？提示：真正的循环
在<a href="https://github.com/python/cpython/blob/3.4/Lib/asyncio/base_events.py">BaseEventLoop的_run_once方法里</a>：）</p>
<h2>实践中使用asyncio的要点</h2>
<p>好了上面的例子很美好，但其实只展示了asyncio一小部分的威力，
下面来一些私人干货。</p>
<h3>在事件处理方法中创建TCP连接</h3>
<p>由于实际上asyncio是在事件循环中调用asyncio.Protocol类
（或者子类）的data_received等方法的，这些事件处理方法
如果阻塞的话，会将整个事件循环也阻塞住，失去了所有“异
步IO”模式带来的好处，所以所有的事件处理方法——包括
data_received、connection_made、connection_lost等——都
不能调用任何可能阻塞的函数，包括socket对象的recv方法、
文件对象的read方法等，当然socket的connect方法由于域名
解析和网络延迟等也是会阻塞的……那我们要怎么从事件处理
方法里做connect操作呢？</p>
<p>答案是asyncio提供了一系列异步操作的、不会阻塞的接口，
当然也包括“创建TCP连接”。这些接口全部以coroutine的形
式提供，调用时要使用<code>yield from</code>语法。例如可以这样搭
建一个简单的代理服务器：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">HOST</span> <span class="o">=</span> <span class="s">&#39;www.google.com&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="s">&#39;80&#39;</span>

<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">new_connection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">client_transport</span><span class="p">,</span> <span class="n">client_proto</span> <span class="o">=</span> <span class="k">yield from</span> \
        <span class="n">loop</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">ClientProtocol</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client_transport</span><span class="p">,</span> <span class="n">client_proto</span>

<span class="k">class</span> <span class="nc">ClientProtocol</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="o">....</span>

<span class="k">class</span> <span class="nc">ServerProtocol</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connection_made</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">new_connection</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_connect_done</span><span class="p">)</span>
        <span class="o">....</span>

    <span class="k">def</span> <span class="nf">client_connect_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="n">client_transport</span><span class="p">,</span> <span class="n">client_proto</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="o">....</span>

<span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">srv</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_server</span><span class="p">(</span><span class="n">ProxyProtocol</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">async</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>ServerProtocol在收到一个新连接（connection_made）的时候用
asyncio.Task调度一个创建新连接的异步函数，这个函数会由asyncio
的事件循环在connection_made返回后择机执行，执行完成后事
件循环再去调用通过add_done_callback注册的处理函数
（client_connect_done），满满的javascript既视感啊有木有。</p>
<p>为什么yield from不能直接写在connection_made里，而需要另外
封装一个函数呢？因为asyncio的事件循环认定了Protocol对象的
事件处理方法是普通函数，如果yield from直接出现在
connection_made中的话，事件循环调用connection_made的时候
只会返回一个generator，connection_made的函数体完全不会被
执行，所以在事件处理方法中只能通过调度Task（或者使用
asyncio.async(...)，效果一样）的方式执行异步操作。</p>
<h3>替换事件循环使用的selector</h3>
<p>Python 3.4中还有一个和asyncio配套的新模块：selectors.
这个模块将select、epoll、kqueue等等系统级异步IO接口抽象
成“selector”类型，规定了统一的对外接口，于是程序只管使
用selector的接口就行了，不用管底层的实现到底是select还
是epoll.</p>
<p>asyncio中用的就是selector模块，
asyncio.selector_events.BaseSelectorEventLoop类的构造
函数有一个selector参数，通常使用默认值就可以了，但是
当然我们也可以把它给换成我们自己的类。比方说如果我们希
望事件循环能支持<a href="http://zeromq.org/">ZeroMQ</a>的socket，
可以把selector的底层实现换成zmq.Poller()：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ZmqSelector</span><span class="p">(</span><span class="n">selectors</span><span class="o">.</span><span class="n">_BaseSelectorImpl</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poller</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">poller</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_poller</span> <span class="o">=</span> <span class="n">poller</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fileobj_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fileobj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_fileobj_lookup</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">events</span> <span class="o">&amp;</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_READ</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span>
        <span class="k">if</span> <span class="n">events</span> <span class="o">&amp;</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_WRITE</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLOUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_poller</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">poll_timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">poll_timeout</span> <span class="o">=</span> <span class="k">None</span>

        <span class="n">select_ready</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zmq_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_poller</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">poll_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ZMQError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">select_ready</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">for</span> <span class="n">sock</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">zmq_events</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_from_fd</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">events</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">ev</span> <span class="o">&amp;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">:</span>
                    <span class="n">events</span> <span class="o">|=</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_READ</span>
                <span class="k">if</span> <span class="n">ev</span> <span class="o">&amp;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLOUT</span><span class="p">:</span>
                    <span class="n">events</span> <span class="o">|=</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_WRITE</span>
                <span class="k">if</span> <span class="n">ev</span> <span class="o">&amp;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLERR</span><span class="p">:</span>
                    <span class="n">events</span> <span class="o">=</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_READ</span> <span class="o">|</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_WRITE</span>
                <span class="n">select_ready</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">events</span> <span class="o">&amp;</span> <span class="n">key</span><span class="o">.</span><span class="n">events</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">select_ready</span>


<span class="k">def</span> <span class="nf">install_zmq_event_loop</span><span class="p">():</span>
    <span class="n">event_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">SelectorEventLoop</span><span class="p">(</span><span class="n">ZmqSelector</span><span class="p">())</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">event_loop</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<h3>将大文件的读写拆成小块</h3>
<p>在事件循环里做任何耗时的操作都是不对的，尤其是IO，
即便是可以随时读写的本地文件，内存里装不下的话还是
会启动硬盘马达让你等个半天。最简单的方法是将大文件
的读写拆分成小块，例如每次只读一页的内容：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AsyncFileWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">DEFAULT_BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">4096</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
                <span class="n">fileobj</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;rb&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="k">None</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Confilicting arguments&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;b&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Only binary mode is supported&#39;</span><span class="p">)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;b&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Only binary mode is supported&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span> <span class="o">=</span> <span class="n">fileobj</span>

        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>     <span class="c"># EOF</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rbuffer</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rbuffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">more_to_go</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rbuffer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">more_to_go</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>     <span class="c"># enough</span>
                <span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbuffer</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbuffer</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
                <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_ready</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">more_to_go</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c"># &lt; 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_ready</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_BLOCK_SIZE</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">future</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_ready</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_ready</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">future</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c"># XXX: big data?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span>
</pre></div>
</td></tr></table>

<p>上面这个类通过不断使用asyncio事件循环的call_soon方法，
重复执行读取小块文件内容的代码（read_ready方法），使得
循环内的其他代码有更多执行机会，典型的以吞吐量换响应速
度。可以在coroutine中这样使用此类：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">some_func</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">afile</span> <span class="o">=</span> <span class="n">AsyncFileWrapper</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;some_file.txt&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">afile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="o">...</span>
</pre></div>
</td></tr></table>

<h2>Errata</h2>
<h3>AsyncFileWrapper</h3>
<p>多谢Robber Phex评论指正，AsyncFileWrapper wrap起来的文
件对象其实还是工作在同步状态下的，需要指定O_NONBLOCK.</p>
<p>另外这个类实际工作时会出现调用close方法之后read_ready方
法又被事件循环回调的情况，所以close方法中还要做额外的清
理工作。</p>
<p>以上修改都在<a href="https://gist.github.com/l04m33/1aa059b1a85c73bc7222/revisions">这个gist里</a>.</p>
</div>

    <div class="sixteen columns">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "blogtheerrorlog";
            var disqus_identifier = "asyncio-in-python-3.html";

            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

        <div class="sixteen columns footer">
                <span>
                    ©
                        2013-2015
                    <strong>Kay Zheng</strong>.
                    除特别说明外，所有内容采用
                    <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><strong>CC BY-NC-SA 3.0</strong></a>
                    许可协议进行许可
                </span>
        </div>
    </div>

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-38877527-1', 'auto');
        ga('require', 'linkid', 'linkid.js');
        ga('require', 'displayfeatures');
        ga('send', 'pageview');
    </script>

    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
        (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
        e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','AzrCxiRLsxpd8WWR-Dsh','2.0.0');
    </script>

</body>

</html>