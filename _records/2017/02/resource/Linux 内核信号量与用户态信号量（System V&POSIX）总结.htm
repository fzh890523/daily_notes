

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script type="text/javascript">
        if (window.location.toString().indexOf("shtml?") > 0) {
            self.location = window.location.toString().replace(window.location.search.toString(), "");
        }
        function doccheckart(json) {
            if (json[0].result == "1") {
                self.location = "http://www.360doc.com/noarticle.aspx";
            }
        }
    </script>
    <script src="/js/jquery1.js" type="text/javascript" charset="utf-8"></script>

    <script type="text/javascript">
        if (navigator.userAgent.indexOf("iPhone") > 0 || navigator.userAgent.indexOf("Android") > 0 || navigator.userAgent.indexOf("iPod") > 0) {  //手机端跳转
            var patt1 = new RegExp("[0-9]*_[0-9]*");
            var url = patt1.exec(location.href);
            if (url != "") {
                self.location = "http://www.360doc.cn/article/" + url + ".html";
            }
        }
    </script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta content="360doc" name="classification" /><link rel="alternate" media="only screen and (max-width: 640px)" href="http://www.360doc.cn/article/9298584_225900606.html"/><meta content="sem,信号,量" name=keywords><meta content="Linux 内核信号量与用户态信号量（System V&amp;POSIX）总结" name=description><meta name="mobile-agent" content="format=html5;url=http://www.360doc.cn/article/9298584_225900606.html"/><meta content="有名信号量在使用的时候，和无名信号量共享sem_wait和sem_post函数。区别是有名信号量使用sem_open代替sem_init，另外在结束的时候要像关闭文件一样去关闭这个有名信号量。在做这个之前，要确定所有对这个有名信号量的引用都已经通过sem_close（）函数关闭了，然后只需在退出或是退出处理函数中调用sem_unlink()去删除系统中的信号量，注意如果有任何的处理器或是线程引用这个信号量，sem_unlink()函数不会起到任何的作用。" name=360docabstract><meta content="www.360doc.com" name="author" /><title>
	Linux 内核信号量与用户态信号量（System V&amp;POSIX）总结
</title>
 
    <script src="/js/showarticlefollow20160329.js?t=2017010403" type="text/javascript" charset="utf-8"></script>
    <script src="http://www.360doc.com/js/jQuery.md5.min.js?t=2016041501" type="text/javascript" charset="utf-8"></script>
    
    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?d86954201130d615136257dde062a503";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <link rel="stylesheet" type="text/css" href="http://css.360doc.com/wzhead-cleaned.css?t=2016011601" /><link rel="stylesheet" type="text/css" href="http://css.360doc.com/newArticle20160509.css?t=2016123001" />
    <script type="text/javascript" language="javascript">
        window.onerror = ignoreError;
        function ignoreError() {
            return true;
        }
    </script>
    <link href="http://css.360doc.com/index7/newheader.css?t=2016123003" rel="stylesheet" type="text/css" /></head>
<body onmouseup="setDragEnd()" onclick="delAllDiv(event)">
    
    <script type="text/javascript">
        var baiduImagePlus = {
            noLogo: true,
            unionId: 'u2617463',
            maxMiniAdCount: 0,
            formList: [{ formId: 10 }]
        };
    </script>
    <script type="text/javascript" src="http://cpro.baidustatic.com/cpro/ui/i.js"></script>
    
    <span id="LayerLogin"></span>

       
    <div style="position:fixed; width:100%; z-index:1000;">
        <div class="header" style="background-color:#ffffff;">
        <div class="header_1">
            <a href="http://www.360doc.com/index.html"><img src="http://pubimage.360doc.com/index7/nlogo.jpg" class="f_left" /></a>
            <div class="mylibrary">
                <a id="userInfoUrl" href="http://www.360doc.com/my360doc.aspx" class="a1">
                    <div class="h_user"><img id="divuserinfonew" src="http://pubimage.360doc.com/index7/dingtu.gif" /><span></span></div>我的图书馆
                </a>
                <ul class="hm_list hm_account" style="display:none;">
                        <li><a href="http://www.360doc.com/myindex.aspx">首页</a></li>
                        <li><a href="http://www.360doc.com/myfiles.aspx?app=1&type=3">馆藏</a></li>
                        <li><a href="http://www.360doc.com/myreadroom.aspx">阅览室</a></li>
                        <li><a href="http://www.360doc.com/mycontacts.aspx">通讯录</a></li>
                        <li><a href="javascript:void(0);" onclick="displaylogin();">退出帐号</a></li>
                    </ul>
            </div>
            <div class="headmail f_left" style="display: none;">
                <p class="h_icon1" id="newMsg"></p>
                <span class="h_border"></span>
                <ul class="hm_list" id="msgtips">
                    <li id="msgicon"><a href="/mymsg.aspx?app=2">查看信箱</a></li>
                    <li id="sysmsgicon"><a href="/mymsg.aspx?app=9">系统消息</a></li>
                    <li id="sysicon"><a href="/mymsg.aspx?app=4">官方通知</a></li>
                    <li class="hm_color2" style="background-color:#f4f4f4"><a href="/mymsg.aspx?app=6">设置</a></li>
                </ul>
            </div>
            <div class="headtalker f_left" style="display: none;">
                <p class="h_icon1" id="newDialog"></p>
                <span class="h_border"></span>
                <ul class="hm_list">
                    <li id="li1chat"><a href="javascript:void(0)" onclick="initchatnew()">开始对话</a></li>
                    <li id="li2chat" style="display:none;"><a href="javascript:void(0)" style="color:#141414;">有<span>11</span>人和你对话，<span onclick="initchatnew()" style="color:#4578b4">查看</span>&nbsp;<span onclick="clearinfochat()" style="color:#4578b4">忽略</span></a></li>
                    <li><a href="http://www.360doc.com/mycontacts.aspx?app=8">历史对话记录</a></li>
                    <li class="hm_color2" style="background-color:#f4f4f4"><a href="http://www.360doc.com/mycontacts.aspx?app=7">通知设置</a></li>
                </ul>
            </div>
            <a href="http://www.360doc.com/advice.html" target="_blank" class="head_talk f_right">留言交流</a>
            <div class="headsearch f_right">
                <div class="zcomdiv">
                    <input type="text" class="headsearch_inp f_left" value="搜文章 找馆友" />
                    <span class="headsearch_btn f_right" id="searchlinkid"></span>
                </div>
                <div class="headsearch_select">
                    <p class="hs_title">请选择搜索范围</p>
                    <a href="javascript:goSearch();" class="cur">含&nbsp;<span></span>&nbsp;的文章</a>
                    <a href="javascript:goSearch();">昵称为&nbsp;<span></span>&nbsp;的馆友</a>
                    <a href="javascript:goSearch();">兴趣为&nbsp;<span></span>&nbsp;的馆友</a>
                </div>
            </div>
        </div>
    </div>
        <div class="arti_type_shadow"></div>
    </div>
    <div style=" height:68px;_height:0px;width:100%;"></div> 

    <div class="clear360doc"></div>

    <div class="doc360article_content">

        <div style="height: 90px; padding-top: 13px;">
            <div id="ADAboveArtContent">
            </div>
        </div>
        <p class="clearboth"></p>
        <div class="a_left">
            <div id="bgchange">
                <div class="fontsize_bgcolor_controler">
                    <div class="a_bgcolor">
                        <img src="http://pubimage.360doc.com/NewArticle/bgcolor.jpg" />
                        <div class="a_colorlist">
                            <span class="a_color1" onclick="artStatistics('20-11-1');">
                                <img src="http://pubimage.360doc.com/NewArticle/yes.gif" /></span>
                            <span class="a_color2" onclick="artStatistics('20-11-2');">
                                <img src="http://pubimage.360doc.com/NewArticle/yes.gif" /></span>
                            <span class="a_color3" onclick="artStatistics('20-11-3');">
                                <img src="http://pubimage.360doc.com/NewArticle/yes.gif" /></span>
                            <span class="a_color4" onclick="artStatistics('20-11-4');">
                                <img src="http://pubimage.360doc.com/NewArticle/yes.gif" /></span>
                            <span class="a_color5" onclick="artStatistics('20-11-5');">
                                <img src="http://pubimage.360doc.com/NewArticle/yes.gif" /></span>
                            <span class="a_color6 cur" onclick="artStatistics('20-11-6');">
                                <img src="http://pubimage.360doc.com/NewArticle/yes.gif" /></span>
                        </div>
                    </div>
                    <div class="a_fontsize">
                        <img src="http://pubimage.360doc.com/NewArticle/fontSize.jpg" />
                        <div class="fschange">
                            <label>
                                <input type="radio" name="font_Size" id="" value="18" onclick="artStatistics('20-10-1');" />大
                           
                            </label>
                            &nbsp;
                           
                            <label>
                                <input type="radio" name="font_Size" id="" value="16" onclick="artStatistics('20-10-2');" />中
                           
                            </label>
                            &nbsp;
                           
                            <label>
                                <input type="radio" name="font_Size" id="" value="14" onclick="artStatistics('20-10-3');" />小
                           
                            </label>
                        </div>
                    </div>
                </div>
                <h2 id="titiletext">Linux 内核信号量与用户态信号量（System V&amp;POSIX）总结</h2>
                <div class="article_data">
                    <div class="article_data_left">
                        2012-07-23
                        <span class="a_username">&nbsp;<a href="http://www.360doc.com/userhome/9298584" id="savernickname" target="_blank" onclick="artStatistics(&#39;20-7-1&#39;);">fhr625</a>
                        </span>
                        <span id="articleinfo">
                            <span id="docsource" class="a_from"></span><span id="360doc_Readnum"></span><span id="360docResaveCount"><span onclick="ShowSaverUser();artStatistics('20-13');" id="360doc_saverNum" style="cursor: pointer;"></span>
                                <span id="360doc_saverUser">
                                    <div style="position: absolute; height: 305px; width: 144px; left: 0px; z-index: 2;" id="sameArtOuter">
                                        <div onclick="event.cancelBubble=true;" style="overflow-y: auto; height: 300px; overflow-x: hidden; z-index: 100; right: 0px; margin-top: -10px;" id="sameArt">
                                        </div>
                                    </div>
                                </span>
                            </span>
                        </span>
                    </div>
                    <div id="resavelayer1" class="bdsharebuttonbox article_data_right">
                    </div>
                </div>
                
                <div id="articlecontent" class="article_container" onmousedown="newhighlight = true;" onmouseup="NewHighlight(event);">
                    <table>
                        <tbody>
                            <tr>
                                <td id="artContent" width="656">
                                    <div style="width: 656px; margin: 0; padding: 0; height: 0;"></div>
                                    <p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>一．什么是信号量</span><span style="line-height: 240%;" lang="EN-US"><?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" /><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'><font style="font-size: 16px;">信号量的使用主要是用来保护共享资源，使得资源在一个时刻只有一个进程（线程）所拥有。</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量的值为正的时候，说明它空闲。所测试的线程可以锁定而使用它。若为</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，说明它被占用，测试的线程要进入睡眠队列中，等待被唤醒。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<h1 style="margin: 17pt 0cm 16.5pt;"><font style="font-size: 16px;"><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>二．信号量的分类</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US"><o:p></o:p></span></font></h1>
<p style="margin: 0cm 0cm 0pt; text-indent: 18pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>在学习信号量之前，我们必须先知道——</span>Linux<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>提供两种信号量：</span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt 53.85pt; line-height: 150%; text-indent: -36pt; tab-stops: list 54.0pt; mso-list: l0 level1 lfo3;" class="MsoNormal"><font style="font-size: 16px;"><font color="#ff0000"><b style="mso-bidi-font-weight: normal;"><span style="mso-bidi-font-family: 宋体;" lang="EN-US"><span style="mso-list: Ignore;">（1）<span style='line-height: normal; font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></b><b style="mso-bidi-font-weight: normal;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>内核信号量，由内核控制路径使用</span><o:p></o:p></b></font></font></p><font color="#ff0000">
</font><p style="margin: 0cm 0cm 0pt 53.85pt; line-height: 150%; text-indent: -36pt; tab-stops: list 54.0pt; mso-list: l0 level1 lfo3;" class="MsoNormal"><font style="font-size: 16px;"><font color="#ff0000"><b style="mso-bidi-font-weight: normal;"><span style="mso-bidi-font-family: 宋体;" lang="EN-US"><span style="mso-list: Ignore;">（2）<span style='line-height: normal; font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></b><b style="mso-bidi-font-weight: normal;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>用户态进程使用的信号量，这种信号量又分为</span>POSIX</b><b style="mso-bidi-font-weight: normal;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量和</span>SYSTEM V</b><b style="mso-bidi-font-weight: normal;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量。</span><o:p></o:p></b></font></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt 17.95pt; text-indent: 5.25pt; mso-para-margin-left: 1.71gd; mso-char-indent-count: .5;" class="MsoNormal"><font style="font-size: 16px;">POSIX<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量又分为有名信号量和无名信号量。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt; mso-char-indent-count: 2.0;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">有名信号量，其值保存在文件中</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">, </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">所以它可以用于线程也可以用于进程间的同步。无名信号量，其值保存在内存中。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 1cm; mso-char-indent-count: 2.7;" class="MsoNormal"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'><font style="font-size: 16px;">倘若对信号量没有以上的全面认识的话，你就会很快发现自己在信号量的森林里迷失了方向。</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<h1 style="margin: 17pt 0cm 16.5pt;"><font style="font-size: 16px;"><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>三．内核信号量</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US"><o:p></o:p></span></font></h1>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style="line-height: 173%;" lang="EN-US">1</span><span style="line-height: 173%; font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial;">．内核信号量的构成</span><span style="line-height: 173%;" lang="EN-US"><o:p></o:p></span></font></h2>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'><font style="font-size: 16px;">内核信号量类似于自旋锁，因为当锁关闭着时，它不允许内核控制路径继续进行。然而，当内核控制路径试图获取内核信号量锁保护的忙资源时，相应的进程就被挂起。只有在资源被释放时，进程才再次变为可运行。</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>只有可以睡眠的函数才能获取内核信号量；中断处理程序和可延迟函数都不能使用内核信号量。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>内核信号量是</span>struct semaphore<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>类型的对象，它在</span>&lt;asm/semaphore.h&gt;<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>中定义：</span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">struct semaphore {<br></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">　　</span></font><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"> atomic_t count;<br></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">　　</span></font><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"> int sleepers;<br></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">　　</span></font><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"> wait_queue_head_t wait;<br></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">　　</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">}</span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>count<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>：相当于信号量的值，大于</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，资源空闲；等于</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，资源忙，但没有进程等待这个保护的资源；小于</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，资源不可用，并至少有一个进程等待资源。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>wait<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>：存放等待队列链表的地址，当前等待资源的所有睡眠进程都会放在这个链表中。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sleepers<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>：存放一个标志，表示是否有一些进程在信号量上睡眠。</span></font></p>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">2</span><span style="line-height: 173%; font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial; mso-bidi-font-size: 16.0pt;">．内核信号量中的等待队列（删除，没有联系）</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h2>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>上面已经提到了内核信号量使用了等待队列</span>wait_queue<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>来实现阻塞操作。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>当某任务由于没有某种条件没有得到满足时，它就被挂到等待队列中睡眠。当条件得到满足时，该任务就被移出等待队列，此时并不意味着该任务就被马上执行，因为它又被移进工作队列中等待</span>CPU<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>资源，在适当的时机被调度。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>内核信号量是在内部使用等待队列的，也就是说该等待队列对用户是隐藏的，无须用户干涉。由用户真正使用的等待队列我们将在另外的篇章进行详解。</span></font></p>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">3</span><span style="line-height: 173%; font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial; mso-bidi-font-size: 16.0pt;">．内核信号量的相关函数</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h2>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>（</span>1<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>）初始化：</span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">void sema_init (struct semaphore *sem, int val);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">void init_MUTEX (struct semaphore *sem);<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>//<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>将</span>sem<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>的值置为</span>1<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，表示资源空闲</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">void init_MUTEX_LOCKED (struct semaphore *sem);<span style="mso-spacerun: yes;">&nbsp; </span>//<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>将</span>sem<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>的值置为</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，表示资源忙</span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>（</span>2<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>）申请内核信号量所保护的资源：</span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">void down(struct semaphore * sem);<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>可引起睡眠</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">int down_interruptible(struct semaphore * sem); <span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>// down_interruptible<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>能被信号打断</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">int down_trylock(struct semaphore * sem);<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>非阻塞函数，不会睡眠。无法锁定资源则</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 231pt; mso-char-indent-count: 22.0;" class="MsoNormal"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'><font style="font-size: 16px;">马上返回</font></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>（</span>3<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>）释放内核信号量所保护的资源：</span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">void up(struct semaphore * sem);</font></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">4</span><span style="line-height: 173%; font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial; mso-bidi-font-size: 16.0pt;">．内核信号量的使用例程</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h2>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>在驱动程序中，当多个线程同时访问相同的资源时（驱动中的全局变量时一种典型的共享资源），可能会引发“竞态“，因此我们必须对共享资源进行并发控制。</span>Linux<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>内核中解决并发控制的最常用方法是自旋锁与信号量（绝大多数时候作为互斥锁使用）。</span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">ssize_t globalvar_write(struct file *filp, const char *buf, size_t len, loff_t *off)<br>{<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span>//<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>获得信号量</span></font><span lang="EN-US"><br></span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'><font style="font-size: 16px;">　</font></span><font style="font-size: 16px;">if (down_interruptible(&amp;sem))<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span></font><font style="font-size: 16px;">{<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　　</span></font><font style="font-size: 16px;">return - ERESTARTSYS;<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span></font><font style="font-size: 16px;">}<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span>//<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>将用户空间的数据复制到内核空间的</span></font><font style="font-size: 16px;">global_var<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span></font><font style="font-size: 16px;">if (copy_from_user(&amp;global_var, buf, sizeof(int)))<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span></font><font style="font-size: 16px;">{<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　　</span></font><font style="font-size: 16px;">up(&amp;sem);<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　　</span></font><font style="font-size: 16px;">return - EFAULT;<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span></font><font style="font-size: 16px;">}<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span>//<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>释放信号量</span></font><span lang="EN-US"><br></span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'><font style="font-size: 16px;">　</font></span><font style="font-size: 16px;">up(&amp;sem);<br><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>　</span></font><span lang="EN-US"><font style="font-size: 16px;">return sizeof(int);<br>}</font></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<h1 style="margin: 17pt 0cm 16.5pt;"><font style="font-size: 16px;"><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>四．</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US">POSIX </span><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>信号量与</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US">SYSTEM V</span><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>信号量的比较</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US"><o:p></o:p></span></font></h1>
<p style="margin: 0cm 0cm 0pt 18pt; text-indent: -18pt; tab-stops: list 18.0pt; mso-list: l1 level1 lfo1;" class="MsoNormal"><font style="font-size: 16px;"><span style='mso-fareast-font-family: "Times New Roman";' lang="EN-US"><span style="mso-list: Ignore;">1.<span style='line-height: normal; font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>对</span>POSIX<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>来说，信号量是个非负整数。常用于线程间同步。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt; mso-char-indent-count: 2.0;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>而</span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量则是一个或多个信号量的集合，它对应的是一个信号量结构体，这个结构体是为</span>SYSTEM V IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>服务的，信号量只不过是它的一部分。常用于进程间同步。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 15.75pt; mso-char-indent-count: 1.5;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">2<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>．</span>POSIX<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量的引用头文件是“</span>&lt;semaphore.h&gt;<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>”，而</span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量的引用头文件是“</span>&lt;sys/sem.h&gt;<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>”。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">3<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>．</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">从使用的角度，</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">System V</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">信号量是复杂的，而</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">Posix</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">信号量是简单。比如，</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">POSIX</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">信号量的创建和初始化或</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">PV</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">操作就很非常方便。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<h1 style="margin: 17pt 0cm 16.5pt;"><font style="font-size: 16px;"><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>五．</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US">POSIX</span><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>信号量详解</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US"><o:p></o:p></span></font></h1>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">1</span><span style="line-height: 173%; font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial; mso-bidi-font-size: 16.0pt;">．无名信号量</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h2>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">无名信号量的创建就像声明一般的变量一样简单，例如：</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_t<span style="mso-spacerun: yes;">&nbsp; </span>sem_id</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">。然后再初始化该无名信号量，之后就可以放心使用了。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;"><font style="background-color: rgb(255, 255, 0);" color="#000000">无名信号量常用于多线程间的同步，同时也用于相关进程间的同步。也就是说，无名信号量必须是多个进程（线程）的共享变量，无名信号量要保护的变量也必须是多个进程（线程）的共享变量，这两个条件是缺一不</font></span></font><font style="font-size: 16px;"><font color="#000000"><font style="background-color: rgb(255, 255, 0);"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">可的。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></font></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">常见的无名信号量相关函数：</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_destroy<o:p></o:p></span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">int sem_init(sem_t *sem, int pshared, unsigned int value);<br>&nbsp;&nbsp;&nbsp; 1)pshared==0 </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">用于同一多线程的同步；</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;<font style="background-color: rgb(255, 255, 0);">&nbsp;<font color="#000000">&nbsp; <font>2)</font></font></font></font></span><font style="font-size: 16px;"><font><font><font style="background-color: rgb(255, 255, 0);"><font color="#000000"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">若</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">pshared&gt;0 </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">用于多个相关进程间的同步（即由</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">fork</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">产生的）</span></font></font></font></font></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">int sem_getvalue(sem_t *sem, int *sval);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">取回信号量</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">的当前值，把该值保存到</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sval</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">中。</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; </font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">若有</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">1</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">个或更多的线程或进程调用</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_wait</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">阻塞在该信号量上，该函数返回两种值：</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 1) </font></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;"><font style="font-size: 16px;">返回</font></span><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">0<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 2) </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">返回阻塞在该信号量上的进程或线程数目</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; linux</font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">采用返回的第一种策略。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_wait(</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">或</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_trywait)</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">相当于</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">P</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">操作，即申请资源。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">int sem_wait(sem_t *sem);<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>// </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">这是一个阻塞的函数</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; </font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">测试所指定信号量的值</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">,</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">它的操作是原子的。</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; </font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">若</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem&gt;0</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">，那么它减</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">1</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">并立即返回。</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; </font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">若</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem==0</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">，则睡眠直到</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem&gt;0</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">，此时立即减</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">1</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">，然后返回。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">int sem_trywait(sem_t *sem);<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>// </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">非阻塞的函数</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; </font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">其他的行为和</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_wait</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">一样，除了：</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; </font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">若</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem==0</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">，不是睡眠，而是返回一个错误</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">EAGAIN</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">相当于</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">V</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">操作，释放资源。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">int sem_post(sem_t *sem);<br>&nbsp;&nbsp;&nbsp; </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">把指定的信号量</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">的值加</span></font><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">1;<br>&nbsp;&nbsp;&nbsp; </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">呼醒正在等待该信号量的任意线程。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">注意：在这些函数中，只有</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_post</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">是信号安全的函数，它是可重入函数</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>（</span><span style="line-height: 173%;" lang="EN-US">a</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>）无名信号量在多线程间的同步</span><span style="line-height: 173%;" lang="EN-US"><o:p></o:p></span></font></h3>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">无名信号量的常见用法是将要保护的变量放在</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_wait</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">和</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_post</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">中间所形成的临界区内，这样该变量就会被保护起来，例如：</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">#include &lt;pthread.h&gt;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">#include &lt;semaphore.h&gt;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">#include &lt;sys/types.h&gt;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">#include &lt;stdio.h&gt;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">#include &lt;unistd.h&gt;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">int number;<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>// </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">被保护的全局变量</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">sem_t sem_id;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">void* thread_one_fun(void *arg)<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">sem_wait(&amp;sem_id);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">printf("thread_one have the semaphore\n");<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">number++;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">printf("number = %d\n",number);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post(&amp;sem_id);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">void* thread_two_fun(void *arg)<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt; mso-char-indent-count: 2.0;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">sem_wait(&amp;sem_id);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">printf("thread_two have the semaphore \n");<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">number--;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">printf("number = %d\n",number);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post(&amp;sem_id);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">int main(int argc,char *argv[])<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>number = 1;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_t id1, id2;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sem_init(&amp;sem_id, 0, 1);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_create(&amp;id1,NULL,thread_one_fun, NULL);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_create(&amp;id2,NULL,thread_two_fun, NULL);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_join(id1,NULL);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_join(id2,NULL);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("main,,,\n");<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return 0;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">上面的例程，到底哪个线程先申请到信号量资源，这是随机的。如果想要某个特定的顺序的话，可以用</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">2</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">个信号量来实现。例如下面的例程是线程</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">1</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">先执行完，然后线程</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">2</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">才继续执行，直至结束。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">int number;<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>// </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">被保护的全局变量</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">sem_t sem_id1, sem_id2;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">void* thread_one_fun(void *arg)<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">sem_wait(&amp;sem_id1);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">printf("thread_one have the semaphore\n");<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">number++;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">printf("number = %d\n",number);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post(&amp;sem_id2);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">void* thread_two_fun(void *arg)<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt; mso-char-indent-count: 2.0;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">sem_wait(&amp;sem_id2);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">printf("thread_two have the semaphore \n");<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">number--;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">printf("number = %d\n",number);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post(&amp;sem_id1);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">int main(int argc,char *argv[])<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>number = 1;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_t id1, id2;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_init(&amp;sem_id1, 0, 1);<span style="mso-spacerun: yes;">&nbsp; </span>// </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">空闲的</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_init(&amp;sem_id2, 0, 0);<span style="mso-spacerun: yes;">&nbsp; </span>// </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">忙的</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_create(&amp;id1,NULL,thread_one_fun, NULL);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_create(&amp;id2,NULL,thread_two_fun, NULL);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_join(id1,NULL);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pthread_join(id2,NULL);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("main,,,\n");<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return 0;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p></td></tr></tbody></table>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">b</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）无名信号量在相关进程间的同步</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">说是相关进程，是因为本程序中共有</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">2</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">个进程，其中一个是另外一个的子进程（由</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">fork<o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">产生）的。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;'> <o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">本来对于</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">fork</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">来说，子进程只继承了父进程的代码副本，</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US">mutex</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">理应在父子进程中是相互独立的两个变量，但由于在初始化mutex的时候，由<span lang="EN-US">pshared = 1</span>指定了mutex处于共享内存区域，所以此时<span lang="EN-US">mutex</span>变成了父子进程共享的一个变量。此时，mutex就可以用来同步相关进程了。<span lang="EN-US"><o:p></o:p></span></span></font></p>
<table style="border: currentColor; width: 585px; height: 842px; text-align: left; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;semaphore.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;stdio.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;errno.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;stdlib.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;unistd.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;sys/types.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;sys/stat.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;fcntl.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;sys/mman.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">int main(int argc, char **argv)<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 2.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">int fd, i,count=0,nloop=10,zero=0,*ptr;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_t mutex;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//open a file and map it into memory<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>fd = open("log.txt",O_RDWR|O_CREAT,S_IRWXU);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>write(fd,&amp;zero,sizeof(int));<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt 90pt; text-align: left; text-indent: -90pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: -7.5; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>ptr = mmap( NULL,sizeof(int),PROT_READ |PROT_WRITE,MAP_SHARED,fd,0 );<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>close(fd);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>/* create, initialize semaphore */<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>if( sem_init(&amp;mutex,1,1) &lt; 0)<span style="mso-spacerun: yes;">&nbsp; </span>//<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;</span>perror("semaphore initilization");<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>exit(0);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 2.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">if (fork() == 0) <o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 2.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{ /* child process*/<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 48pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 4.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">for (i = 0; i &lt; nloop; i++) <o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 48pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 4.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sem_wait(&amp;mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>printf("child: %d\n", (*ptr)++);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sem_post(&amp;mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 48pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 4.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;</span>exit(0);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 2.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>/* back to parent process */<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">for (i = 0; i &lt; nloop; i++) <o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 48pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 4.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">sem_wait(&amp;mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;</span>printf("parent: %d\n", (*ptr)++);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;</span>sem_post(&amp;mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-char-indent-count: 2.0; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>exit(0);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US">}</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;">2<span style="font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial;">．有名信号量</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h2>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">有名信号量的特点是把信号量的值保存在文件中。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">这决定了它的用途非常广：既可以用于线程，也可以用于相关进程间，甚至是不相关进程。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">a</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）有名信号量能在进程间共享的原因</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">由于有名信号量的值是保存在文件中的，所以对于相关进程来说，子进程是继承了父进程的文件描述符，那么子进程所继承的文件描述符所指向的文件是和父进程一样的，当然文件里面保存的有名信号量值就共享了。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">b</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）有名信号量相关函数说明</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">有名信号量在使用的时候，和无名信号量共享</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_wait</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">和</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_post</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">函数。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">区别是有名信号量使用</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_open</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">代替</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_init</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">，另外在结束的时候要像关闭文件一样去关闭这个有名信号量。</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">(1)</font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">打开一个已存在的有名信号量，或创建并初始化一个有名信号量。一个单一的调用就完成了信号量的创建、初始化和权限的设置。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;">sem_t *sem_open(const char *name,&nbsp;&nbsp;int oflag, mode_t mode , int value);<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt; mso-char-indent-count: 2.0;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">name</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">是文件的路径名；</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt; mso-char-indent-count: 2.0;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">Oflag </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">有</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">O_CREAT</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">或</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">O_CREAT|EXCL</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">两个取值；</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt 21pt; mso-para-margin-left: 2.0gd;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">mode_t</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">控制新的信号量的访问权限；</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><br><font style="font-size: 16px;">Value</font></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">指定信号量的初始化值。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt 21pt; mso-para-margin-left: 2.0gd;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><font color="#ff0000"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">注意：</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></font></p><font color="#ff0000">
</font><p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><font style="font-family: 宋体;"><font color="#ff0000"><font style="font-family: Arial;"><font><font style="background-color: rgb(255, 255, 0);"><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">这里的</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">name</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">不能写成</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">/tmp/aaa.sem</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">这样的格式，因为在</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">linux</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">下，</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">sem</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">都是创建在</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">/dev/shm</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">目录下。你可以将</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">name</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">写成“</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">/mysem</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">”或“</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">mysem</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">”，创建出来的文件都是“</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">/dev/shm/sem.mysem</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">”，千万不要写路径。也千万不要写“</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US">/tmp/mysem</span><span style="color: black; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">”之类的。</span><span style="color: black; mso-bidi-font-size: 10.5pt;" lang="EN-US"><o:p></o:p></span></font></font></font></font></font></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">当</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">oflag = O_CREAT</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">时，若</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">name</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">指定的信号量不存在时，则会创建一个，而且后面的</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">mode</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">和</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">value</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">参数必须有效。若</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">name</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">指定的信号量已存在，则直接打开该信号量，同时忽略</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">mode</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">和</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">value</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">参数。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">当</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">oflag = O_CREAT|O_EXCL</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">时，若</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">name</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">指定的信号量已存在，该函数会直接返回</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">error</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">(2) </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">一旦你使用了一信号量，销毁它们就变得很重要。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">在做这个之前，要确定所有对这个有名信号量的引用都已经通过</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_close</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">（）函数关闭了，然后只需在退出或是退出处理函数中调用</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_unlink()</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">去删除系统中的信号量，注意如果有任何的处理器或是线程引用这个信号量，</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_unlink()</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">函数不会起到任何的作用。</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p></o:p></span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">也就是说，必须是最后一个使用该信号量的进程来执行</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">sem_unlick</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">才有效。</span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>因为每个信号灯有一个引用计数器记录当前的打开次数，</span>sem_unlink<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>必须等待这个数为</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>时才能把</span>name<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>所指的信号灯从文件系统中删除。也就是要等待最后一个</span>sem_close<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>发生。</span></font></p>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">c</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）有名信号量在无相关进程间的同步</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>前面已经说过，有名信号量是位于共享内存区的，那么它要保护的资源也必须是位于共享内存区，只有这样才能被无相关的进程所共享。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>在下面这个例子中，服务进程和客户进程都使用</span>shmget<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>和</span>shmat<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>来获取得一块共享内存资源。然后利用有名信号量来对这块共享内存资源进行互斥保护。</span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568"><pre><strong><span style="font-family: 宋体; mso-bidi-font-family: 宋体;" lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&lt;u&gt;File1: server.c &lt;/u&gt;</font></span></strong></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/types.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/ipc.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/shm.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;stdio.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;semaphore.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/types.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/stat.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;fcntl.h&gt;</font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#define SHMSZ 27</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">char SEM_NAME[]= "vik";</font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">int main()</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">{</font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>char ch;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>int shmid;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>key_t key;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>char *shm,*s;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_t *mutex;</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//name the shared memory segment</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>key = 1000;</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//create &amp; initialize semaphore</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>mutex = sem_open(SEM_NAME,O_CREAT,0644,1);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>if(mutex == SEM_FAILED)</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>perror("unable to create semaphore");</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_unlink(SEM_NAME);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(-1);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//create the shared memory segment with this key</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>shmid = shmget(key,SHMSZ,IPC_CREAT|0666);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;</span>if(shmid&lt;0)</font></font></span></pre><pre style="text-indent: 24pt; mso-char-indent-count: 2.0;"><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">{</font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>perror("failure in shmget");</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>exit(-1);</font></font></span></pre><pre style="text-indent: 24pt; mso-char-indent-count: 2.0;"><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">}</font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//attach this segment to virtual memory</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>shm = shmat(shmid,NULL,0);</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//start writing into memory</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>s = shm;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>for(ch='A';ch&lt;='Z';ch++)</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_wait(mutex);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>*s++ = ch;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_post(mutex);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span>}</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//the below loop could be replaced by binary semaphore</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>while(*shm != '*')</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sleep(1);</font></font></span></pre><pre style="text-indent: 24pt; mso-char-indent-count: 2.0;"><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">}</font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_close(mutex);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_unlink(SEM_NAME);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>shmctl(shmid, IPC_RMID, 0);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>exit(0);</font></font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">}</font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;">&lt;u&gt;<strong><span style="font-family: 宋体; mso-bidi-font-family: 宋体;">File 2: client.c</span></strong>&lt;/u&gt;</font></font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/types.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/ipc.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/shm.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;stdio.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;semaphore.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/types.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;sys/stat.h&gt;</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#include &lt;fcntl.h&gt;</font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">#define SHMSZ 27</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">char SEM_NAME[]= "vik";</font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">int main()</font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">{</font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>char ch;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>int shmid;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>key_t key;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>char *shm,*s;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_t *mutex;</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//name the shared memory segment</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>key = 1000;</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//create &amp; initialize existing semaphore</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>mutex = sem_open(SEM_NAME,0,0644,0);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>if(mutex == SEM_FAILED)</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>perror("reader:unable to execute semaphore");</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_close(mutex);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>exit(-1);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//create the shared memory segment with this key</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>shmid = shmget(key,SHMSZ,0666);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>if(shmid&lt;0)</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>perror("reader:failure in shmget");</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>exit(-1);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//attach this segment to virtual memory</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>shm = shmat(shmid,NULL,0);</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//start reading</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>s = shm;</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>for(s=shm;*s!=NULL;s++)</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_wait(mutex);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>putchar(*s);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post(mutex);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</font></font></span></pre><pre><span lang="EN-US"><o:p><font style="font-size: 16px; background-color: rgb(239, 239, 239);">&nbsp;</font></o:p></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>//once done signal exiting of reader:This can be replaced by another semaphore</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>*shm = '*';</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>sem_close(mutex);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>shmctl(shmid, IPC_RMID, 0);</font></font></span></pre><pre><span lang="EN-US"><font style="background-color: rgb(239, 239, 239);"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>exit(0);</font></font></span></pre><pre><span lang="EN-US"><font style="font-size: 16px; background-color: rgb(239, 239, 239);">}</font></span></pre>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<h1 style="margin: 17pt 0cm 16.5pt;"><font style="font-size: 16px;"><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>六．</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US">SYSTEM V</span><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>信号量</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US"><o:p></o:p></span></font></h1>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>这是信号量值的集合，而不是单个信号量。相关的信号量操作函数由</span>&lt;sys/ipc.h&gt;<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>引用。</span></font></p>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">1</span><span style="line-height: 173%; font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial; mso-bidi-font-size: 16.0pt;">．信号量结构体</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h2>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>内核为每个信号量集维护一个信号量结构体，可在</span>&lt;sys/sem.h&gt;<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>找到该定义：</span></font></p>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">struct semid_ds {</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>struct ipc_perm sem_perm;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>/* <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量集的操作许可权限</span>*/</font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;">struct sem *sem_base;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>某个信号量</span>sem<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构数组的指针，当前信号量集</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 174pt; mso-char-indent-count: 16.57;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>中的每个信号量对应其中一个数组元素</span>*/</font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span>ushort sem_nsems;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* sem_base <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>数组的个数</span>*/</font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>time_t sem_otime;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>最后一次成功修改信号量数组的时间</span>*/</font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>time_t sem_ctime;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>成功创建时间</span>*/</font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">};</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">struct sem {<br>&nbsp;&nbsp;&nbsp; ushort semval;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">信号量的当前值</span></font><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"> */<br>&nbsp;&nbsp;&nbsp; short&nbsp; sempid;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">最后一次返回该信号量的进程</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">ID</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">号</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;'><font style="font-size: 16px;"> </font><span lang="EN-US"><font style="font-size: 16px;">*/<br>&nbsp;&nbsp;&nbsp; ushort semncnt;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* </font></span></span><font style="font-size: 16px;"><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">等待</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">semval</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">大于当前值的进程个数</span></font><font style="font-size: 16px;"><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"> */<br>&nbsp;&nbsp;&nbsp; ushort semzcnt;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* </span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">等待</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">semval</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">变成</span><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US">0</span><span style="color: black; font-family: 宋体; mso-ascii-font-family: Verdana; mso-hansi-font-family: Verdana; mso-bidi-font-size: 10.5pt;">的进程个数</span></font><span style='color: black; font-family: "Verdana","sans-serif"; mso-bidi-font-size: 10.5pt;' lang="EN-US"><font style="font-size: 16px;"> */<br>};</font></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;">2<span style="font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial;">．常见的</span>SYSTEM V<span style="font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial;">信号量函数</span></font></h2>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">a</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）关键字和描述符</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量是</span>SYSTEM V IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>（即</span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>进程间通信）的组成部分，其他的有</span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>消息队列，</span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>共享内存。而关键字和</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>描述符无疑是它们的共同点，也使用它们，就不得不先对它们进行熟悉。这里只对</span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量进行讨论。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>描述符相当于引用</span>ID<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>号，要想使用</span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量（或</span>MSG<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>、</span>SHM<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>），就必须用</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>描述符来调用信号量。而</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>描述符是内核动态提供的（通过</span>semget<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>来获取），用户无法让服务器和客户事先认可共同使用哪个描述符，所以有时候就需要到关键字</span>KEY<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>来定位描述符。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>某个</span>KEY<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>只会固定对应一个描述符（这项转换工作由内核完成），这样假如服务器和客户事先认可共同使用某个</span>KEY<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，那么大家就都能定位到同一个描述符，也就能定位到同一个信号量，这样就达到了</span>SYSTEM V<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量在进程间共享的目的。</span></font></p>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">b</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）创建和打开信号量</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><b style="mso-bidi-font-weight: normal;"><span lang="EN-US"><font style="font-size: 16px;">int semget(key_t <span style="mso-spacerun: yes;">&nbsp;</span>key, int <span style="mso-spacerun: yes;">&nbsp;</span>nsems, int <span style="mso-spacerun: yes;">&nbsp;</span>oflag)<o:p></o:p></font></span></b></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(1) nsems&gt;0<span style="mso-spacerun: yes;">&nbsp; </span>: <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>创建一个信的信号量集，指定集合中信号量的数量，一旦创建就不能更改。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(2) nsems==0 : <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>访问一个已存在的集合</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(3) <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>返回的是一个称为信号量标识符的整数，</span>semop<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>和</span>semctl<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>函数将使用它。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(4) <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>创建成功后信号量结构被设置：</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>.sem_perm <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>的</span>uid<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>和</span>gid<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>成员被设置成的调用进程的有效用户</span>ID<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>和有效组</span>ID</font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>.oflag <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>参数中的读写权限位存入</span>sem_perm.mode</font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>.sem_otime <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>被置为</span>0,sem_ctime<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>被设置为当前时间</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>.sem_nsems <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>被置为</span>nsems<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>参数的值</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>该集合中的每个信号量不初始化，这些结构是在</span>semctl<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，用参数</span>SET_VAL<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，</span>SETALL<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>初始化的。</span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>semget<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>函数执行成功后，就产生了一个由内核维持的类型为</span>semid_ds<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构体的信号量集，返回</span>semid<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>就是指向该信号量集的引索。</span></font></p>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">c</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）关键字的获取</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>有多种方法使客户机和服务器在同一</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构上会合：</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(1) <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>服务器可以指定关键字</span>IPC_PRIVATE<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>创建一个新</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构，将返回的标识符存放在某处（例如一个文件）以便客户机取用。关键字</span>IPC_PRIVATE<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>保证服务器创建一个新</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构。这种技术的缺点是：服务器要将整型标识符写到文件中，然后客户机在此后又要读文件取得此标识符。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;">IPC_PRIVATE<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>关键字也可用于父、子关系进程。父进程指定</span>IPC_PRIVATE<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>创建一个新</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构，所返回的标识符在</span>fork<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>后可由子进程使用。子进程可将此标识符作为</span>exec<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>函数的一个参数传给一个新程序。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(2) <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>在一个公用头文件中定义一个客户机和服务器都认可的关键字。然后服务器指定此关键字创建一个新的</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构。这种方法的问题是该关键字可能已与一个</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构相结合，在此情况下，</span>get<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>函数（</span>msgget<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>、</span>semget<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>或</span>shmget<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>）出错返回。服务器必须处理这一错误，删除已存在的</span>IPC<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构，然后试着再创建它。当然，这个关键字不能被别的程序所占用。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(3) <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>客户机和服务器认同一个路径名和课题</span>I D<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>（课题</span>I D<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是</span>0 ~ 2 5 5<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>之间的字符值）</span> <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，然后调用函数</span>ftok<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>将这两个值变换为一个关键字。这样就避免了使用一个已被占用的关键字的问题。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><font style=""><font style=""><font style=""><font style=""><font style=""><font style=""><font style=""><font style=""><font style="background-color: rgb(255, 255, 0);"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>使用</span>ftok<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>并非高枕无忧。有这样一种例外：服务器使用</span>ftok<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>获取得一个关键字后，该文件就被删除了，然后重建。此时客户端以此重建后的文件来</span>ftok<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>所获取的关键字就和服务器的关键字不一样了。所以一般商用的软件都不怎么用</span>ftok<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>。</span></font></font></font></font></font></font></font></font></font></font></p><font style="background-color: rgb(255, 255, 0);">
</font><p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><font style=""><font style=""><font style=""><font style=""><font style=""><font style=""><font style=""><font style=""><font style="background-color: rgb(255, 255, 0);"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>一般来说，客户机和服务器至少共享一个头文件，所以一个比较简单的方法是避免使用</span>ftok<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，而只是在该头文件中存放一个大家都知道的关键字。</span></font></font></font></font></font></font></font></font></font></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><span style="mso-tab-count: 1;"><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span></span></p>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">d</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）设置信号量的值（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">PV</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>操作）</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">int semop(int <span style="mso-spacerun: yes;">&nbsp;</span>semid, struct <span style="mso-spacerun: yes;">&nbsp;</span>sembuf <span style="mso-spacerun: yes;">&nbsp;</span>*opsptr, size_t <span style="mso-spacerun: yes;">&nbsp;</span>nops);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(1) semid<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>：</span> <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是</span>semget<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>返回的</span>semid</font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(2)opsptr<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>：</span> <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>指向信号量操作结构数组</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(3) nops <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>：</span> opsptr<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>所指向的数组中的</span>sembuf<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>结构体的个数</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">struct sembuf {</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>short sem_num;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>// <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>要操作的信号量在信号量集里的编号，</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>short sem_op;<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>// <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量操作</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>short sem_flg;<span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;</span>// <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>操作表示符</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">};</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;">(4) <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>若</span>sem_op <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是正数，其值就加到</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>上，即释放信号量控制的资源</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>若</span>sem_op <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，那么调用者希望等到</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>变为</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，如果</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是</span>0<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>就返回</span>;</font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>若</span>sem_op <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是负数，那么调用者希望等待</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>变为大于或等于</span>sem_op<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>的绝对值</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>例如，当前</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>为</span>2<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，而</span>sem_op = -3<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，那么怎么办？</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>注意：</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是指</span>semid_ds<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>中的信号量集中的某个信号量的值</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">(5) sem_flg </font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>SEM_UNDO<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>由进程自动释放信号量</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>IPC_NOWAIT<span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>不阻塞</span></font></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><span style="mso-tab-count: 1;"><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>到这里，读者肯定有个疑惑：</span>semop<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>希望改变的</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>到底在哪里？我们怎么没看到有它的痕迹？其实，前面已经说明了，当使用</span>semget<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>时，就产生了一个由内核维护的信号量集（当然每个信号量值即</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>也是只由内核才能看得到了），用户能看到的就是返回的</span>semid<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>。内核通过</span>semop<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>函数的参数，知道应该去改变</span>semid<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>所指向的信号量的哪个</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>。</span></font></p>
<h3 style="margin: 13pt 0cm;"><font size="5"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>（</span>e<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>）对信号集实行控制操作（</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>的赋值等）</span><span style="line-height: 173%;" lang="EN-US"><o:p></o:p></span></font></font></h3>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><b style="mso-bidi-font-weight: normal;"><span lang="EN-US"><font style="font-size: 16px;">int semctl(int <span style="mso-spacerun: yes;">&nbsp;</span>semid, int <span style="mso-spacerun: yes;">&nbsp;</span>semum, int <span style="mso-spacerun: yes;">&nbsp;</span>cmd, ../* union semun arg */);<o:p></o:p></font></span></b></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;">semid<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是信号量集合；</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;">semnum<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是信号在集合中的序号；</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;">semum<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>是一个必须由用户自定义的结构体，在这里我们务必弄清楚该结构体的组成：</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">union semun</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">{</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>int val;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>// cmd == SETVAL</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>struct semid_ds *buf<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>// cmd == IPC_SET<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>或者</span>cmd == IPC_STAT </font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>ushort *array;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// cmd == SETALL<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>，或</span>cmd = GETALL </font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">};</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;">val<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>只有</span>cmd ==SETVAL<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>时才有用，此时指定的</span>semval = arg.val<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>注意：当</span>cmd == GETVAL<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>时，</span>semctl<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>函数返回的值就是我们想要的</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>。千万不要以为指定的</span>semval<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>被返回到</span>arg.val<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>中。</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>array<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>指向一个数组，当</span>cmd==SETALL<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>时，就根据</span>arg.array<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>来将信号量集的所有值都赋值；当</span>cmd ==GETALL<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>时，就将信号量集的所有值返回到</span>arg.array<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>指定的数组中。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;">buf<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>指针只在</span>cmd==IPC_STAT<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>或</span>IPC_SET<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>时有用，作用是</span>semid<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>所指向的信号量集（</span>semid_ds<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>机构体）。一般情况下不常用，这里不做谈论。</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>另外，</span>cmd == IPC_RMID<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>还是比较有用的。</span></font></p>
<h3 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>（</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">f</span><span style='line-height: 173%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 16.0pt;'>）例码</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h3>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">#include &lt;sys/types.h&gt;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">#include &lt;sys/ipc.h&gt;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">#include &lt;sys/sem.h&gt;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">#include &lt;stdio.h&gt;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">static<span style="mso-spacerun: yes;">&nbsp; </span>int<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>nsems;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">static int semflg;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">static int semid;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">int<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>errno=0;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">union semun {</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>int val;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp; </span>struct semid_ds *buf;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp; </span>unsigned short *array;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-tab-count: 1;">&nbsp; </span>}arg;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">int main()</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">{</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>struct sembuf sops[2];<span style="mso-spacerun: yes;">&nbsp; </span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US">//</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">要用到两个信号量，所以要定义两个操作数组</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>int rslt;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>unsigned short argarray[80];</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>arg.array = argarray;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>semid = semget(IPC_PRIVATE, 2, 0666);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if(semid &lt; 0 )</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("semget failed.<span style="mso-spacerun: yes;">&nbsp; </span>errno: %d\n", errno);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(0);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><span style="mso-tab-count: 1;"><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>//<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>获取</span>0th<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量的原始值</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>rslt = semctl(semid, 0, GETVAL);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("val = %d\n",rslt);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>//<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>初始化</span>0th<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量，然后再读取，检查初始化有没有成功</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt; mso-char-indent-count: 2.0;" class="MsoNormal"><font style="font-size: 16px;">arg.val = 1; // <span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>同一时间只允许一个占有者</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>semctl(semid, 0, SETVAL, arg);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>rslt = semctl(semid, 0, GETVAL);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("val = %d\n",rslt);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun: yes;"><font style="font-size: 16px;">&nbsp;&nbsp;&nbsp; </font></span></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sops[0].sem_num = 0;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sops[0].sem_op = -1; </font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sops[0].sem_flg = 0;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sops[1].sem_num = 1;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sops[1].sem_op = 1;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sops[1].sem_flg = 0;</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>rslt=semop(semid, sops, 1); //<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>申请</span>0th<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量，尝试锁定</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (rslt &lt; 0 ) </font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("semop failed.<span style="mso-spacerun: yes;">&nbsp; </span>errno: %d\n", errno);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(0);</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">}</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;">//<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>可以在这里对资源进行锁定</span></font></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">sops[0].sem_op = 1;</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><font style="font-size: 16px;">semop(semid, sops, 1); //<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>释放</span>0th<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>信号量</span></font></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>rslt = semctl(semid, 0, GETVAL);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("val = %d\n",rslt);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span>rslt=semctl(semid, 0, GETALL, arg);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (rslt &lt; 0) </font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("semctl failed.<span style="mso-spacerun: yes;">&nbsp; </span>errno: %d\n", errno);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(0);</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">}</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">printf("val1:%d<span style="mso-spacerun: yes;">&nbsp; </span>val2: %d\n",(unsigned int)argarray[0],(unsigned int)argarray[1]);</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">if(semctl(semid, 1, IPC_RMID) == -1)</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">{</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>Perror(“semctl failure while clearing reason”);</font></span></p>
<p style="margin: 0cm 0cm 0pt; text-indent: 21.75pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">}</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return(0);</font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><font style="font-size: 16px;">}</font></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<h1 style="margin: 17pt 0cm 16.5pt;"><font style="font-size: 16px;"><span style='line-height: 240%; font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman"; mso-bidi-font-size: 22.0pt;'>七．信号量的牛刀小试——生产者与消费者问题</span><span style="line-height: 240%; mso-bidi-font-size: 22.0pt;" lang="EN-US"><o:p></o:p></span></font></h1>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">1</span><span style="line-height: 173%; font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial; mso-bidi-font-size: 16.0pt;">．问题描述：</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h2>
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><font style="font-size: 16px;"><span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>有一个长度为</span>N<span style='font-family: 宋体; mso-ascii-font-family: "Times New Roman"; mso-hansi-font-family: "Times New Roman";'>的缓冲池为生产者和消费者所共有，只要缓冲池未满，生产者便可将消息送入缓冲池；只要缓冲池未空，消费者便可从缓冲池中取走一个消息。生产者往缓冲池放信息的时候，消费者不可操作缓冲池，反之亦然。</span></font></p>
<h2 style="margin: 13pt 0cm;"><font style="font-size: 16px;"><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US">2</span><span style="line-height: 173%; font-family: 黑体; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial; mso-bidi-font-size: 16.0pt;">．使用多线程和信号量解决该经典问题的互斥</span><span style="line-height: 173%; mso-bidi-font-size: 16.0pt;" lang="EN-US"><o:p></o:p></span></font></h2>
<table style="border: currentColor; border-collapse: collapse; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480;" class="MsoTableGrid" border="1" cellSpacing="0" cellPadding="0">
<tbody>
<tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes; mso-yfti-lastrow: yes;">
<td style="padding: 0cm 5.4pt; border: 1pt solid windowtext; width: 426.1pt; background-color: transparent; mso-border-alt: solid windowtext .5pt;" vAlign="top" width="568">
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;pthread.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;stdio.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#include &lt;semaphore.h&gt;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">#define BUFF_SIZE 10<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">char buffer[BUFF_SIZE];<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US">char count;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// </span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">缓冲池里的信息数目<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US">sem_t sem_mutex;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// </span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">生产者和消费者的互斥锁<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US">sem_t p_sem_mutex; <span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;</span>// </span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">空的时候，对消费者不可进<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US">sem_t c_sem_mutex; <span style="mso-spacerun: yes;">&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;</span>// </span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">满的时候，对生产者不可进<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">void * Producer()<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">while(1)<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sem_wait(&amp;p_sem_mutex); //</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">当缓冲池未满时<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sem_wait(&amp;sem_mutex); <span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">等待缓冲池空闲<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>count++;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sem_post(&amp;sem_mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if(count &lt; BUFF_SIZE)//</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">缓冲池未满<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post(&amp;p_sem_mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if(count &gt; 0)<span style="mso-spacerun: yes;">&nbsp; </span>//</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">缓冲池不为空<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post(&amp;c_sem_mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">void * Consumer()<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">while(1)<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sem_wait(&amp;c_sem_mutex);//</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">缓冲池未空时<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><font style="font-size: 16px;"><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sem_wait(&amp;sem_mutex);<span style="mso-spacerun: yes;">&nbsp; </span>//</span><span style="font-family: 宋体; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;">等待缓冲池空闲<o:p></o:p></span></font></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>count--;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sem_post(&amp;sem_mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if(count &gt; 0)<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sem_post(c_sem_nutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; text-indent: 24pt; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">int main()<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>pthread_t ptid,ctid;<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>//initialize the semaphores<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>sem_init(&amp;empty_sem_mutex,0,1);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>sem_init(&amp;full_sem_mutex,0,0);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>//creating producer and consumer threads<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>if(pthread_create(&amp;ptid, NULL,Producer, NULL))<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("\n ERROR creating thread 1");<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(1);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;</span>if(pthread_create(&amp;ctid, NULL,Consumer, NULL))<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("\n ERROR creating thread 2");<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(1);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>if(pthread_join(ptid, NULL)) /* wait for the producer to finish */<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("\n ERROR joining thread");<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(1);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>if(pthread_join(ctid, NULL)) /* wait for consumer to finish */<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("\n ERROR joining thread");<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(1);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>sem_destroy(&amp;empty_sem_mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>sem_destroy(&amp;full_sem_mutex);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>//exit the main thread<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>pthread_exit(NULL);<o:p></o:p></font></span></p>
<p style="background: rgb(239, 239, 239); margin: 0cm 0cm 0pt; text-align: left; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; mso-pagination: widow-orphan;" class="MsoNormal" align="left"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;"><span style="mso-spacerun: yes;">&nbsp; </span>return 1;<o:p></o:p></font></span></p>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span style="font-family: 宋体; font-size: 12pt; mso-bidi-font-family: 宋体; mso-font-kerning: 0pt;" lang="EN-US"><font style="font-size: 16px;">}</font></span></p></td></tr></tbody></table>
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span lang="EN-US"><o:p><font style="font-size: 16px;">&nbsp;</font></o:p></span></p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="viewerPlaceHolder" style="width: 717px; height: 700px; display: none; margin: 0 auto;">
                    </div>
                </div>
                <table>
                    <tbody>
                        <tr>
                            <td>
                                <ul></ul>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div></div>
                <span></span>
                <a></a>
                <p style="margin: 0; padding: 0;"></p>
                <p class="clearboth"></p>
                <div class="bdsharebuttonbox bottombtn">
                    <div class="zcommond" style="overflow: visible;">
                        <a href="javascript:void(0);" class="btn_collect" onclick="SaveArt();artStatistics('20-3-2');">转藏到我的图书馆</a>
                        <a id="flowimg3" href="javascript:void(0);" class="btn_good" onclick="Showflowerlayer('sendedLayer1');">献花（<span id="articleflowernum">0</span>）
                        <span id="flowernumadd" style="display: none;">+1</span>

                        </a>
                        <span class="span1 f_left" onclick="setTimeout(function(){$('.bottombtn .sharelist_new').slideToggle(0);},10);artStatistics('20-8-3');" onmouseover="this.style.color='#0f659c'" onmouseout="this.style.color=''">分享：</span>
                        <a class="sharewx f_left" href="javascript:void(0);" onclick="shareWeixin();artStatistics('20-8-6');">微信</a>
                        <div class="s2 f_left" onclick="setTimeout(function(){$('.bottombtn .sharelist_new').slideToggle(0);},10);artStatistics('20-8-4');"><span></span></div>
                    </div>
                    <div class="sharelist_new" id="fenxiangLayer2">
                        <a class="slbg1" href="javascript:void(0);" data-cmd="qzone" onclick="artStatistics('20-8-8');">QQ空间</a>
                        <a class="slbg2" href="javascript:void(0);" data-cmd="sqq" onclick="artStatistics('20-8-10');">QQ好友</a>
                        <a class="slbg3" href="javascript:void(0);" data-cmd="tsina" onclick="artStatistics('20-8-12');">新浪微博</a>
                        <a class="slbg4" href="javascript:void(0);" data-cmd="tqq" onclick="artStatistics('20-8-14');">腾讯微博</a>
                        <a class="slbg5" href="javascript:void(0);" onclick="showdivemail1();artStatistics('20-8-16');">推荐给朋友</a>
                    </div>
                </div>
                <div class="bottom_controler">
                    <p class="bottom_cleft">
                        来自：
                         <span class="a_username" style="width: auto;">
                             <a href="http://www.360doc.com/userhome/9298584" id="savernickname2" target="_blank" onclick="artStatistics(&#39;20-7-2&#39;);">fhr625</a>
                         </span>
                        &gt; 
                        <span id="cname" class="a_from"></span>
                    </p>
                    <div class="bottom_cright">
                        <a href=" https://www.baidu.com/s?wd=sem+%e4%bf%a1%e5%8f%b7+%e9%87%8f&tn=SE_hldp01010_6r0gix1f" target="_blank" class="a1" onclick="artStatistics('20-19');">以文找文</a>
                        &nbsp;&nbsp;|&nbsp;&nbsp;
                        <a href="javascript:void(0);" class="a2" onclick="showAlertLayer1();artStatistics('20-18');">举报</a>
                    </div>
                </div>
                <div class="prev_next">
                    <p id="lastart" class="p1">
                    </p>
                    <p id="nextart" class="p2">
                    </p>
                </div>
            </div>
            <p class="clearboth"></p>
            <div style="width: 676px; float: left;">
                <div class="str_border" style="border: none; position: relative; z-index: 2;">
                    <strong>猜你喜欢</strong>
                </div>
                <ul class="youlike" style="margin-top: -18px; position: relative; z-index: 1;">
                    <div  style="width: 676px; height: 280px; border: 0;" id="divyoulikead">


                    </div>
                    
                </ul>
                <div class="zcommond" style="padding: 10px 0 20px;">
                    <div class="bottom_article f_left">
                        <div class="str_border">
                            <strong>类似文章</strong>
                            <a href=http://www.360doc.com/relevant/225900606_more.shtml target='_blank' class='a_more f_right'  onclick='artStatistics('20-9-8');'>更多</a>
                        </div>
                        <ul class="barticle_list">
                            
                                    <li><span><a href=http://www.360doc.com/content/12/0114/21/532901_179423486.shtml target=_blank onclick='artStatistics("20-9-7");'>信号量的控制——semctl函数及相关的结构...</a></span></li>
                                
                                    <li><span><a href=http://www.360doc.com/content/12/0722/23/9298584_225895213.shtml target=_blank onclick='artStatistics("20-9-7");'>Linux System V信号量&amp;POSIX信号量区...</a></span></li>
                                
                                    <li><span><a href=http://www.360doc.com/content/10/0709/13/4910_37844727.shtml target=_blank onclick='artStatistics("20-9-7");'>Port Windows IPC apps to Linux, Part ...</a></span></li>
                                
                                    <li><span><a href=http://www.360doc.com/content/12/0114/21/532901_179423086.shtml target=_blank onclick='artStatistics("20-9-7");'>信号量的操作——semop函数</a></span></li>
                                
                                    <li><span><a href=http://www.360doc.com/content/14/0803/11/16285334_399087671.shtml target=_blank onclick='artStatistics("20-9-7");'>多进程之信号量 Linux函数 semget();sem...</a></span></li>
                                
                                    <li><span><a href=http://www.360doc.com/content/11/1209/20/1030755_171103741.shtml target=_blank onclick='artStatistics("20-9-7");'>System V semaphore: semget() semop() ...</a></span></li>
                                
                                    <li><span><a href=http://www.360doc.com/content/15/0303/15/7377734_452230443.shtml target=_blank onclick='artStatistics("20-9-7");'>【linux草鞋应用编程系列】</a></span></li>
                                
                                    <li><span><a href=http://www.360doc.com/content/07/0830/22/26230_706528.shtml target=_blank onclick='artStatistics("20-9-7");'>Linux环境进程间通信（四）</a></span></li>
                                
                        </ul>
                    </div>
                    <div class="bottom_article f_right">
                        <div class="str_border">
                            <strong>精选文章</strong>
                        </div>
                        <ul class="barticle_list">
                            
                                    <li><span><a onclick="artStatistics('20-9-9');" href=http://www.360doc.com/content/13/0126/23/909770_262506199.shtml target="_blank">傻妹子，防狼喷雾不是这么用滴</a></span></li>
                                
                                    <li><span><a onclick="artStatistics('20-9-9');" href=http://www.360doc.com/content/14/0514/23/7542574_377546542.shtml target="_blank">坚持下来了，这就是你的资本</a></span></li>
                                
                                    <li><span><a onclick="artStatistics('20-9-9');" href=http://www.360doc.com/content/13/0114/18/7602161_260057111.shtml target="_blank">中华趣味文化大合集</a></span></li>
                                
                                    <li><span><a onclick="artStatistics('20-9-9');" href=http://www.360doc.com/content/14/0323/03/13527074_362758224.shtml target="_blank">中国人与欧洲人生活差距在哪？</a></span></li>
                                
                                    <li><span><a onclick="artStatistics('20-9-9');" href=http://www.360doc.com/content/13/1207/02/3899427_335028448.shtml target="_blank">倾国之恋</a></span></li>
                                
                                    <li><span><a onclick="artStatistics('20-9-9');" href=http://www.360doc.com/content/14/0418/08/9986257_369912129.shtml target="_blank">官场潜规:64条定律</a></span></li>
                                
                                    <li><span><a onclick="artStatistics('20-9-9');" href=http://www.360doc.com/content/14/1214/18/1655598_432791819.shtml target="_blank">上帝的调色板：一个国家一种颜色，中国的颜色简直美哭了！</a></span></li>
                                
                                    <li><span><a onclick="artStatistics('20-9-9');" href=http://www.360doc.com/content/14/0313/09/7858166_360138481.shtml target="_blank">中国人常用的10句话</a></span></li>
                                
                        </ul>
                    </div>
                </div>
                
                <div  style="width: 676px; height: 202px;" id="divunderZcommondAd"></div>
                
                <div class="zcommond" style="margin-top: 10px;">
                    
                    <div class="f_left" style="width: 300px; height: 90px;" id="divaboveReflectionAd1">
                        
                    </div>
                    
                    <div class="f_left" style="width: 300px; height: 90px; margin-left: 44px;" id="divaboveReflectionAd2">
                        
                    </div>
                </div>

                <p></p>
                <div id="ReflectionPart">
                    <div style="height: 156px; margin: 0px 0px;">
                        <div class="plbox">
                            <div class="plmain">
                                <div class="titwx" style="height: 23px;">
                                    发表评论：
                                </div>
                                <textarea name="SendRefTB" id="SendRefTB" style="width: 100%; height: 75px; border: 1px solid #e7e7e7; background-color: #fff; overflow: auto; font-size: 12px;"
                                    onfocus="testContent(1);" onblur="testContent(2)"></textarea>
                                <div style="text-align: right; padding-right: 3px; padding-top: 6px;">
                                    <div class="huifubt">
                                        <a id="ImgSendPL" href="javascript:void(0);" onclick="SubmitReflection();"></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="padding-top: 15px; padding-left: 15px;" id="Reflction">
                </div>
            </div>
        </div>
        <div class="a_right">
            <div class="user_info">
                <div class="user_photo f_left">
                    <p class="user_photopic">
                        <a href="http://www.360doc.com/userhome/9298584" id="userphotourl" target="_blank" onclick="artStatistics(&#39;20-7-4&#39;);">
                            <img src="http://pubimage.360doc.com/head/ancient/006.gif" id="userphoto" width="58" height="58" />
                        </a>
                    </p>
                    <a href="javascript:void(0);" onclick="docTalk();artStatistics('20-15');" class="user_talk" title="与TA对话"></a>
                </div>
                <div class="user_data f_right">
                    <div class="user_data_name">
                        <a href="http://www.360doc.com/userhome/9298584" id="nickname" target="_blank" onclick="artStatistics(&#39;20-7-3&#39;);">fhr625</a>
                        <img src="http://pubimage.360doc.com/NewArticle/user_name_tag.gif" alt="图书馆" />
                    </div>
                    <p id="userdegree"><img src='http://pubimage.360doc.com/NewArticle/userstar2.gif' /><img src='http://pubimage.360doc.com/NewArticle/userstar3.gif' /><img src='http://pubimage.360doc.com/NewArticle/userstar3.gif' /><img src='http://pubimage.360doc.com/NewArticle/userstar3.gif' /><img src='http://pubimage.360doc.com/NewArticle/userstar3.gif' /></p>
                    <div class="user_data_num">
                        <a id="spanfollowstatus" class="gz_no"></a>
                        <script type="text/javascript">isfollow(9298584);</script>
                        <span id="follownum">2</span>&nbsp;&nbsp;&nbsp;&nbsp;
                        <span>馆藏</span>&nbsp;<span id="artnum">37</span>
                    </div>
                </div>
            </div>
            <div class="his_her"><ul class='his_her_type'><li class='f_left curone'>TA的最新馆藏</li></ul><div class='his_her_div' style="height:190px;"><ul class='his_her_list'><li><div><span></span><a href=http://www.360doc.com/content/14/0123/17/9298584_347387131.shtml target=_blank onclick="artStatistics('20-9-3');">怎样写linux下的USB设备驱动程序</a></div><div><span></span><a href=http://www.360doc.com/content/13/1030/17/9298584_325372264.shtml target=_blank onclick="artStatistics('20-9-3');">Android之Bluetooth</a></div><div><span style="color:#b0b0b0;">[转]&nbsp;</span><a href=http://www.360doc.com/content/11/0922/10/474846_150305483.shtml target=_blank onclick="artStatistics('20-9-3');">Android上成功实现了蓝牙的一些Profile</a></div><div><span></span><a href=http://www.360doc.com/content/13/1009/09/9298584_320007782.shtml target=_blank onclick="artStatistics('20-9-3');">Android APK反编译详解</a></div><div><span></span><a href=http://www.360doc.com/content/13/1008/22/9298584_319943340.shtml target=_blank onclick="artStatistics('20-9-3');">Android Bluetooth</a></div><div><span style="color:#b0b0b0;">[转]&nbsp;</span><a href=http://www.360doc.com/content/12/0418/17/9766274_204705128.shtml target=_blank onclick="artStatistics('20-9-3');">wpa_supplicant学习</a></div></li></ul></div></div>





<div class="clear360doc" style="padding-top: 10px; height: 260px;">
    <div id="divifartad1"></div>
    
    <div style="height: 10px;">
    </div>
</div>

<div class="his_her" id="recommendArt" style="margin-top: 5px;">
    <div class="str_border" style="margin: 0;">
        <span style="font-size: 14px; float: left;">推荐阅读</span>
        <a style="float: right;" class="a_more" onclick="artStatistics('20-9-4');" href="http://www.360doc.com/readroom.html" target="_blank">更多</a>
    </div>
    <div class='his_her_div' style="height: 264px;">
        <ul class='his_her_list'>
            <li id="recommendArtLists"></li>
        </ul>
    </div>
</div>



<div class="clear360doc" style="padding-top: 10px;" id="divifartad2">
    
</div>
<br />


<div id="divifartrightsogou">
    </div>
            <div class="clear360doc" id="divad5" style="padding-top: 11px; zoom: 1; width: 300px;">
                <div id="divad4" style="display: none;">
                    <div id="divifartad">
                        
                        
                    </div>
                    <div class="ggwz">
                        <a href="javascript:void(0);" onclick="closead(2);">关闭</a>
                    </div>
                    <div style="height: 13px;">
                    </div>
                </div>
                <div style="clear: both; display: none;" id="divad6">
                    <div id="adfloatbaidu">
                        
                    </div>
                    <div class="ggwz" style="left: 25px;">
                        <a href="javascript:void(0);" onclick="closead(3);">关闭</a>
                    </div>
                    <div style="height: 13px;">
                    </div>
                </div>
                <div style="height: 75px;">
                </div>
            </div>
        </div>
    </div>
    <p class="clearboth"></p>
    <input type="hidden" id="artid" value="225900606" />
    <input type="hidden" id="docarttitle" value="Linux+%e5%86%85%e6%a0%b8%e4%bf%a1%e5%8f%b7%e9%87%8f%e4%b8%8e%e7%94%a8%e6%88%b7%e6%80%81%e4%bf%a1%e5%8f%b7%e9%87%8f%ef%bc%88System+V%26POSIX%ef%bc%89%e6%80%bb%e7%bb%93" />
    <input type="hidden" id="firstartid" value="225900606" />
    <input type="hidden" id="subclassid" value="-1" />
    <input type="hidden" id="recommendart1" value="225895213" />
    <input type="hidden" id="recommendart2" value="-1" />
    <input type="hidden" id="isowner" value="False" />
    <input type="hidden" id="artreadroomid" value="0" />
    <script src="http://www.360doc.com/js/showarticle.js?t=2017012103" type="text/javascript" charset="utf-8"></script>
    <script>GerLookingUserInfo(1,9298584,1,1,'-1',-1,10,0);OutputSource('http://www.360doc.com/userhome/9298584','');OutputCategory(9298584,3,'%e3%80%8aLinux+%e4%bf%a1%e5%8f%b7%e9%87%8f%e3%80%8b');OutputLastNextArt('Linux+System+V%e4%bf%a1%e5%8f%b7%e9%87%8f%26POSIX%e4%bf%a1%e5%8f%b7%e9%87%8f%e5%8c%ba%e5%88%ab','http://www.360doc.com/content/12/0722/23/9298584_225895213.shtml',0);</script>
        <script type="text/javascript" src="http://www.360doc.com/js/index7/newheader.js?t=2016123014"></script>
        <script type="text/javascript" src="/js/Statistics/addStatistics.js?t=2017011303"></script>
        <script src="http://blockart.360doc.com/ajax/getstatusv2.ashx?aid=225900606" type="text/javascript" charset="utf-8" async="async"></script>

</body>
</html>